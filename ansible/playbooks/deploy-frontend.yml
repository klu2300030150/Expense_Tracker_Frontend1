---
# Frontend Deployment Playbook with Nginx
# Usage: ansible-playbook -i inventory.ini playbooks/deploy-frontend.yml

- name: Deploy Frontend with Nginx
  hosts: webservers
  become: yes
  gather_facts: yes

  vars_files:
    - ../group_vars/all.yml

  vars:
    nginx_root: /var/www/expense-tracker
    backend_url: "http://localhost:{{ app_port }}"

  tasks:
    # ============================================
    # NGINX INSTALLATION
    # ============================================
    - name: Install Nginx
      yum:
        name: nginx
        state: present
      tags: nginx

    - name: Start Nginx service
      systemd:
        name: nginx
        state: started
        enabled: yes
      tags: nginx

    # ============================================
    # BUILD FRONTEND
    # ============================================
    - name: Install frontend dependencies
      npm:
        path: "{{ app_directory }}"
        state: present
      become_user: "{{ app_user }}"
      tags: build

    - name: Build frontend for production
      command: npm run build
      args:
        chdir: "{{ app_directory }}"
      become_user: "{{ app_user }}"
      environment:
        VITE_API_URL: "{{ backend_url }}"
      tags: build

    # ============================================
    # DEPLOY FRONTEND FILES
    # ============================================
    - name: Create nginx root directory
      file:
        path: "{{ nginx_root }}"
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'
      tags: deploy

    - name: Copy built files to nginx root
      copy:
        src: "{{ app_directory }}/dist/"
        dest: "{{ nginx_root }}/"
        remote_src: yes
        owner: nginx
        group: nginx
        mode: '0644'
      tags: deploy

    # ============================================
    # NGINX CONFIGURATION
    # ============================================
    - name: Create Nginx configuration
      template:
        src: ../templates/nginx.conf.j2
        dest: /etc/nginx/conf.d/expense-tracker.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload Nginx
      tags: nginx

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/conf.d/default.conf
        state: absent
      notify: Reload Nginx
      tags: nginx

    - name: Test Nginx configuration
      command: nginx -t
      register: nginx_test
      changed_when: false
      tags: nginx

    # ============================================
    # FIREWALL CONFIGURATION
    # ============================================
    - name: Allow HTTP port through firewall
      firewalld:
        service: http
        permanent: yes
        state: enabled
      ignore_errors: yes
      tags: firewall

    - name: Allow HTTPS port through firewall
      firewalld:
        service: https
        permanent: yes
        state: enabled
      ignore_errors: yes
      tags: firewall

    - name: Reload firewalld
      command: firewall-cmd --reload
      ignore_errors: yes
      tags: firewall

  handlers:
    - name: Reload Nginx
      systemd:
        name: nginx
        state: reloaded
