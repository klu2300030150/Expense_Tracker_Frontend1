---
# Main Playbook - Deploy Expense Tracker to AWS EC2
# Usage: ansible-playbook -i inventory.ini site.yml

- name: Deploy Expense Tracker Application
  hosts: webservers
  become: yes
  gather_facts: yes

  vars_files:
    - group_vars/all.yml

  tasks:
    # ============================================
    # SYSTEM SETUP
    # ============================================
    - name: Update system packages
      yum:
        name: "*"
        state: latest
      tags: system

    - name: Install required packages
      yum:
        name:
          - git
          - curl
          - wget
        state: present
      tags: system

    # ============================================
    # NODE.JS INSTALLATION
    # ============================================
    - name: Check if Node.js is installed
      command: node --version
      register: node_version
      ignore_errors: yes
      changed_when: false
      tags: nodejs

    - name: Download Node.js setup script
      get_url:
        url: "https://rpm.nodesource.com/setup_{{ nodejs_version }}.x"
        dest: /tmp/node_setup.sh
        mode: '0755'
      when: node_version.failed
      tags: nodejs

    - name: Run Node.js setup script
      command: bash /tmp/node_setup.sh
      when: node_version.failed
      tags: nodejs

    - name: Install Node.js
      yum:
        name: nodejs
        state: present
      tags: nodejs

    - name: Verify Node.js installation
      command: node --version
      register: node_installed
      changed_when: false
      tags: nodejs

    - name: Display Node.js version
      debug:
        msg: "Node.js version: {{ node_installed.stdout }}"
      tags: nodejs

    # ============================================
    # PM2 INSTALLATION
    # ============================================
    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
        state: present
      tags: pm2

    # ============================================
    # APPLICATION DEPLOYMENT
    # ============================================
    - name: Check if application directory exists
      stat:
        path: "{{ app_directory }}"
      register: app_dir
      tags: deploy

    - name: Clone application repository
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_directory }}"
        version: "{{ github_branch }}"
        force: yes
      become_user: "{{ app_user }}"
      when: not app_dir.stat.exists
      tags: deploy

    - name: Pull latest changes
      git:
        repo: "{{ github_repo }}"
        dest: "{{ app_directory }}"
        version: "{{ github_branch }}"
        update: yes
      become_user: "{{ app_user }}"
      when: app_dir.stat.exists
      tags: deploy

    - name: Install npm dependencies
      npm:
        path: "{{ app_directory }}"
        state: present
      become_user: "{{ app_user }}"
      tags: deploy

    # ============================================
    # ENVIRONMENT CONFIGURATION
    # ============================================
    - name: Create .env file
      template:
        src: templates/env.j2
        dest: "{{ app_directory }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0600'
      tags: config

    # ============================================
    # PM2 APPLICATION MANAGEMENT
    # ============================================
    - name: Stop existing PM2 process
      command: pm2 delete {{ pm2_app_name }}
      become_user: "{{ app_user }}"
      ignore_errors: yes
      changed_when: false
      tags: pm2

    - name: Start application with PM2
      command: pm2 start server.js --name {{ pm2_app_name }}
      args:
        chdir: "{{ app_directory }}"
      become_user: "{{ app_user }}"
      tags: pm2

    - name: Save PM2 process list
      command: pm2 save
      become_user: "{{ app_user }}"
      tags: pm2

    - name: Setup PM2 startup script
      command: pm2 startup systemd -u {{ app_user }} --hp /home/{{ app_user }}
      register: pm2_startup
      changed_when: false
      tags: pm2

    - name: Execute PM2 startup command
      shell: "{{ pm2_startup.stdout_lines[-1] }}"
      when: pm2_startup.stdout_lines | length > 0
      ignore_errors: yes
      tags: pm2

    # ============================================
    # HEALTH CHECK
    # ============================================
    - name: Wait for application to start
      wait_for:
        port: "{{ app_port }}"
        delay: 5
        timeout: 60
      tags: health

    - name: Check application health
      uri:
        url: "http://localhost:{{ app_port }}/api/health"
        method: GET
        return_content: yes
      register: health_check
      tags: health

    - name: Display health check result
      debug:
        msg: "Health check response: {{ health_check.content }}"
      tags: health

    # ============================================
    # FINAL STATUS
    # ============================================
    - name: Get PM2 status
      command: pm2 status
      become_user: "{{ app_user }}"
      register: pm2_status
      changed_when: false
      tags: status

    - name: Display PM2 status
      debug:
        msg: "{{ pm2_status.stdout_lines }}"
      tags: status

  handlers:
    - name: Restart application
      command: pm2 restart {{ pm2_app_name }}
      become_user: "{{ app_user }}"
